<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metronom2</title>
    <script src="jatos.js"></script>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-plugin-try.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-function-tap.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<style>
    .instruction{
        text-align: center;
        top: 10%;
        left: 20%;
        font-size: 80px;
    }
</style>
<body>
<script>

    /*****CONSTANTS****/
    TEMPOS_IN_MS = [200,341,583,997,1704];
    TIME_BEFORE_VIBRATE_IN_MS = 500;  //half a second
    VIBRATION_LENGTH = 70;
    NUM_STIMULI_TRIAL = 30;

    //-----saving data-----//
    // function saveData(name, data){
    //     var xhr = new XMLHttpRequest();
    //     xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
    //     xhr.setRequestHeader('Content-Type', 'application/json');
    //     xhr.send(JSON.stringify({filename: name, filedata: data}));
    // }

    //*****instructions*****//
    var test_stimuli = [
        {stimulus: '<h3 class="instruction">שלום!!, ברוך הבא לניסוי שלנו</h3><p class="instruction">אנא חבר אוזניות </p><p class="instruction"> כדי לשמוע את ההוראות</p>'},
        {stimulus: '<p class="instruction">אורך הניסוי הוא כ-20 דקות  </p><p class="instruction"> אנא שב במקום נוח</p>'},
        { stimulus: '<p class="instruction">שב במקום שקט וללא הפרעות</p><br><br><br>'},
        { stimulus: '<p class="instruction">הוצא את הטלפון </p><p class="instruction">מהכיסוי (קייס)</p>'},
        {stimulus: '<p class="instruction">.החזק את הטלפון ביד החזקה</p><p class="instruction"> אל תחליף ידיים לאורך הניסוי</p>'},
        {stimulus: '<p class="instruction">אנא חבר אוזניות, וודא שהן</p><p class="instruction">יושבות בנוחות בשתי אוזנייך</p>'},
        {stimulus: '<p class="instruction">שים את הפלאפון במצב</p><p class="instruction">(לא במצב שקט)רעש</p>'},
        {stimulus: '<p class="instruction">שים את הפלאפון על ווליום </p><p class="instruction">הכי גבוה/אמצע</p>'},
        {stimulus: '<p class="instruction">אנא צא מכל האפליקציות </p><p class="instruction">הרקע האחרות</p>'}
    ];
    var instruction = {
        type: "html-button-response",
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['המשך']
    };
    var test_procedure = {
        timeline: [instruction],
        timeline_variables: test_stimuli
    };

    var finished = {
        type: 'html-button-response',
        stimulus: '<p class="instruction">You have finished</p><p class="instruction"> the experiment</p><br><p class="instruction">Thank you</p>',
        choices: ['Continue'],
    };
    /////////////////////////////////////////

    //training//
    var vibration_check = {
        type: 'survey-text',
        questions: [
            {prompt: "כמה רטטיטות הרגשת?"},
        ],
        on_start: function () {
            navigator.vibrate([1,500,70,517,70,517,70,517,70,517,70,517]);
        },
        on_finish: function () {
            var all_data = jsPsych.data.get();
            console.log(all_data.csv());
            jsPsych.data.displayData('csv');
        }
    };
    /////////////

    //*******tactile block********//
    function create_vibration_tempo_arrays() {
        tempos_arrays = [];
        for(var i=0; i<TEMPOS_IN_MS.length; i++)
        {
            tempo_array = [];
            tempo_array.push(1);
            tempo_array.push(TIME_BEFORE_VIBRATE_IN_MS);
            for(var j=0; j<NUM_STIMULI_TRIAL; j++)
            {
                tempo_array.push(VIBRATION_LENGTH);
                tempo_array.push(TEMPOS_IN_MS[i]-VIBRATION_LENGTH);
            }
            tempos_arrays.push(tempo_array);
        }
    }
    create_vibration_tempo_arrays();

    var first_tempo_200_pink = {
        type: 'function-tap',
        stimulus: 'sounds/pink_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_duration: TEMPOS_IN_MS[0]*60,
        on_start: function () {
            alert("vibrating");
            navigator.vibrate(tempos_arrays[0]);
        }
    };

    var second_tempo_341 = {
        type: 'function-tap',
        stimulus: 'sounds/pink_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_duration: TEMPOS_IN_MS[1]*60,
        on_start: function () {
            alert("vibrating");
            navigator.vibrate(tempos_arrays[1]);
        }
    };

    var third_tempo_583 = {
        type: 'function-tap',
        stimulus: 'sounds/pink_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_duration: TEMPOS_IN_MS[2]*60,
        on_start: function () {
            alert("vibrating");
            navigator.vibrate(tempos_arrays[2]);
        }
    };

    var forth_tempo_997 = {
        type: 'function-tap',
        stimulus: 'sounds/pink_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_duration: TEMPOS_IN_MS[3]*60,
        on_start: function () {
            alert("vibrating");
            navigator.vibrate(tempos_arrays[3]);
        }
    };

    var fifth_tempo_1704 = {
        type: 'function-tap',
        stimulus: 'sounds/pink_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_duration: TEMPOS_IN_MS[4]*60,
        on_start: function () {
            alert("vibrating");
            navigator.vibrate(tempos_arrays[4]);
        }
    };

    all_types = [first_tempo_200_pink,second_tempo_341,third_tempo_583,forth_tempo_997,fifth_tempo_1704];
    // tactile_block = jsPsych.randomization.repeat(all_types,4);
    tactile_block = jsPsych.randomization.repeat(all_types,1);  //for now change to 1
    ////////////////////////////////////////////////////////////


    /*****proof of concept*****/
    // var trial_sound_POC = {
    //     type: 'function-tap',
    //     stimulus: 'sounds/tone_10.wav',
    //     choices: ['Tap'],
    //     prompt: "<p>when the sound is over, try tapping on the button with the same tempo</p>",
    //     trial_duration: 8000
    // };
    //
    // var trial_tactile_POC = {
    //     type: 'function-tap',
    //     stimulus: '',
    //     choices: ['Tap'],
    //     prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
    //     trial_duration: 8000,
    //     on_start: function () {
    //         alert("vibrating");
    //         navigator.vibrate([400,100,400,100,400,100,400,100,400,100,400,100]);
    //     }
    // };

    ///-------------------time line-------------------///
    var timeline = [];
    timeline.push(test_procedure);
    timeline.push(vibration_check);
    //push tactile block
    for(var i = 0; i<tactile_block.length; i++)
    {
        timeline.push(tactile_block[i]);
    }
    timeline.push(finished);

    ///----------------------init----------------------///

    jatos.onLoad(function() {
        jsPsych.init({
            timeline: timeline,
        });
    });

</script>
</body>
</html>