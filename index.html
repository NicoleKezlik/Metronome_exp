<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metronom2</title>
<!--    comment jatos for run in github    -->
<!--    <script src="jatos.js"></script>-->
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-plugin-try.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-function-tap.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<style>
    .instruction{
        text-align: center;
        top: 10%;
        left: 20%;
        font-size: 80px;
    }
</style>
<body>
<script>

    /*****CONSTANTS****/
    TEMPOS_IN_MS = [200,341,583,997,1704];
    TIME_BEFORE_VIBRATE_IN_MS = 1000;  // a second
    VIBRATION_LENGTH = 70;
    NUM_STIMULI_TRIAL = 30;
    CONTRA_BALANCE = Math.round(Math.random()); // 0 auditory block is first, 1 tactile block is first
    tactile_train_success = 0;
    current_response = 6;
    train_timeline = [];
    trial_num = 1;
    exp_completed = 0;
    AUDIO_PATH = "new_sounds/auditory_with_pink";
    TACTILE_PATH = "new_sounds/tactile_with_silence";
    TYPE = ".wav";
    audio = [];
    for(i = 1; i<6; i++)
    {
        audio.push(AUDIO_PATH+i+TYPE);
        audio.push(TACTILE_PATH+i+TYPE);
    }


    //-----saving data-----//
    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }

    //*****instructions*****//
    var test_stimuli = [
        {stimulus: '<h3 class="instruction">שלום!!, ברוך הבא לניסוי שלנו</h3><p class="instruction">אנא חבר אוזניות </p><p class="instruction"> כדי לשמוע את ההוראות</p>'},
        {stimulus: '<p class="instruction">אורך הניסוי הוא כ-20 דקות  </p><p class="instruction"> אנא שב במקום נוח</p>'},
        {stimulus: '<p class="instruction">שב במקום שקט וללא הפרעות</p><br><br><br>'},
        {stimulus: '<p class="instruction">הוצא את הטלפון </p><p class="instruction">מהכיסוי (קייס)</p>'},
        {stimulus: '<p class="instruction">.החזק את הטלפון ביד החזקה</p><p class="instruction"> אל תחליף ידיים לאורך הניסוי</p>'},
        {stimulus: '<p class="instruction">אנא חבר אוזניות, וודא שהן</p><p class="instruction">יושבות בנוחות בשתי אוזנייך</p>'},
        {stimulus: '<p class="instruction">שים את הפלאפון במצב</p><p class="instruction">(לא במצב שקט)רעש</p>'},
        {stimulus: '<p class="instruction">שים את הפלאפון על ווליום </p><p class="instruction">הכי גבוה/אמצע</p>'},
        {stimulus: '<p class="instruction">אנא צא מכל האפליקציות </p><p class="instruction">הרקע האחרות</p>'}
    ];
    var instruction = {
        type: "html-button-response",
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['המשך']
    };
    var instruction_procedure = {
        timeline: [instruction],
        timeline_variables: test_stimuli,
        on_start: function () {
            alert("exp_start");
            jsPsych.data.addProperties({exp_start:Date.now()});
        }
    };

    var train_begin = {
        type: "html-button-response",
        stimulus: '<p class="instruction">נתחיל באימון קצר</p><p class="instruction">ואחריו יתחיל הניסוי עצמו</p>',
        choices: ['המשך']
    };

    var volume_configuration = {
        type: 'image-button-response',
        stimulus: 'img/happy_face_1.png',
        choices: ['continue',],
        prompt: "<p>במהלך הניסוי יישמע רעש רקע.</p><p>יש לשים את הווליום בערך באמצע</p>"
    };

    var finished = {
        type: 'html-button-response',
        stimulus: '<p class="instruction">You have finished</p><p class="instruction"> the experiment</p><br><p class="instruction">Thank you</p>',
        choices: ['Continue'],
    };
    /////////////////////////////////////////

    //---------training----------//
    var third_tempo_583_train_6_vibes = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence3.wav',
        choices: [],
        prompt: "<p>Count the number of vibrations you feel  6</p>",
        trial_duration: 4600,
        data: {test_pp: '0'},
        on_start: function () {
            navigator.vibrate([1,TIME_BEFORE_VIBRATE_IN_MS,70,517,70,517,70,517,70,517,70,517,70,517]);
        }
    };
    var first_tempo_200_train_9_vibes = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence1.wav',
        choices: [],
        prompt: "<p>Count the number of vibrations you feel  9</p>",
        trial_duration: 2800,
        on_start: function () {
            navigator.vibrate([1,TIME_BEFORE_VIBRATE_IN_MS,70,130,70,130,70,130,70,130,70,130,70,130]);
        }
    };
    var fifth_tempo_1704_train_4_vibes = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence5.wav',
        choices: [],
        prompt: "<p>Count the number of vibrations you feel  4</p>",
        trial_duration: 2800,
        on_start: function () {
            navigator.vibrate([1,TIME_BEFORE_VIBRATE_IN_MS,70,1634,70,1634,70,1634,70,1634]);
        }
    };
    var check_train = {
        type: 'html-button-response',
        stimulus: '<p>How many vibrations did you feel?</p>',
        choices: ['0','1', '2','3','4','5','6','7','8','9','10'],
        prompt: ""
    };

    // train_timeline.push(third_tempo_583_train_6_vibes,check_train);

    var loop_node = {
        timeline: [third_tempo_583_train_6_vibes,check_train],
        loop_function: function(data){
            var data = jsPsych.data.getLastTrialData();
            var jsonData = data.json();
            jsonData = JSON.parse(jsonData);
            var responses = JSON.parse(jsonData[0].button_pressed);
            if(responses===0)
            {
                alert("please make sure your phone is not muted")
            }
            return responses!==6;
        }
    };
    var loop_node2 = {
        timeline: [loop_node,first_tempo_200_train_9_vibes,check_train],
        loop_function: function(data){
            var data = jsPsych.data.getLastTrialData();
            var jsonData = data.json();
            jsonData = JSON.parse(jsonData);
            var responses = JSON.parse(jsonData[0].button_pressed);
            if(responses===0)
            {
                alert("please make sure your phone is not muted")
            }
            return responses!==9;
        }
    };
    var loop_node3 = {
        timeline: [loop_node2,fifth_tempo_1704_train_4_vibes,check_train],
        loop_function: function(data){
            var data = jsPsych.data.getLastTrialData();
            var jsonData = data.json();
            jsonData = JSON.parse(jsonData);
            var responses = JSON.parse(jsonData[0].button_pressed);
            if(responses===0)
            {
                alert("please make sure your phone is not muted")
            }
            return responses!==4;
        }
    };
    /////////////////////////////////////////

    //*******tactile block********//
    function create_vibration_tempo_arrays() {
        tempos_arrays = [];
        for(var i=0; i<TEMPOS_IN_MS.length; i++)
        {
            tempo_array = [];
            tempo_array.push(1);
            tempo_array.push(TIME_BEFORE_VIBRATE_IN_MS);
            for(var j=0; j<NUM_STIMULI_TRIAL; j++)
            {
                tempo_array.push(VIBRATION_LENGTH);
                tempo_array.push(TEMPOS_IN_MS[i]-VIBRATION_LENGTH);
            }
            tempos_arrays.push(tempo_array);
        }
    }
    create_vibration_tempo_arrays();
    var vib_on=-1;

    var first_tempo_200_pink = {
        type: 'function-tap',
        on_start: function () {
            vib_on = Date.now();
            jsPsych.data.addProperties({vibration_on:Date.now()});
            navigator.vibrate(tempos_arrays[0]);
            jsPsych.data.addProperties({vibration_off:Date.now()});
        },
        stimulus: 'new_sounds/tactile_with_silence1.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        data: {trial_num:trial_num,modality:'1',practice:'0',trial_tempo:'200'},
    };

    var second_tempo_341 = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence2.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_ends_after_audio:true,
        data: {trial_num:trial_num,modality:'1',practice:'0',trial_tempo:'341'},
        on_start: function () {
            jsPsych.data.addProperties({vibration_on:Date.now()});
            navigator.vibrate(tempos_arrays[1]);
            jsPsych.data.addProperties({vibration_off:Date.now()});
        }
    };

    var third_tempo_583 = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence3.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_ends_after_audio:true,
        data: {trial_num:trial_num,modality:'1',practice:'0',trial_tempo:'583'},
        on_start: function () {
            jsPsych.data.addProperties({vibration_on:Date.now()});
            navigator.vibrate(tempos_arrays[2]);
            jsPsych.data.addProperties({vibration_off:Date.now()});
        }
    };

    var forth_tempo_997 = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence4.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_ends_after_audio:true,
        data: {trial_num:trial_num,modality:'1',practice:'0',trial_tempo:'997'},
        on_start: function () {
            jsPsych.data.addProperties({vibration_on:Date.now()});
            navigator.vibrate(tempos_arrays[3]);
            jsPsych.data.addProperties({vibration_off:Date.now()});
        }
    };

    var fifth_tempo_1704 = {
        type: 'function-tap',
        stimulus: 'new_sounds/tactile_with_silence5.wav',
        choices: ['Tap'],
        prompt: "<p>when the vibration is over, try tapping on the button with the same tempo</p>",
        trial_ends_after_audio:true,
        data: {trial_num:trial_num,modality:'1',practice:'0',trial_tempo:'1704'},
        on_start: function () {
            jsPsych.data.addProperties({vibration_on:Date.now()});
            navigator.vibrate(tempos_arrays[4]);
            jsPsych.data.addProperties({vibration_off:Date.now()});
        }
    };

    // all_types_tactile = [first_tempo_200_pink];
    all_types_tactile = [first_tempo_200_pink,second_tempo_341,third_tempo_583,forth_tempo_997,fifth_tempo_1704];
    // tactile_block = jsPsych.randomization.repeat(all_types,4);
    tactile_block = jsPsych.randomization.repeat(all_types_tactile,1);  //for now change to 1
    ////////////////////////////////////////////////////////////

    //*******auditory block********//
    var first_auditory_200_pink = {
        type: 'function-tap',
        stimulus: 'new_sounds/auditory_with_pink1.wav',
        choices: ['Tap'],
        data: {trial_num:trial_num,modality:'0',practice:'0',trial_tempo:'200'},
        prompt: "<p>try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        on_finish: function () {
            trial_num++;
        },
        on_start:function () {
            // alert(trial_num);
        }
    };

    var second_auditory_341 = {
        type: 'function-tap',
        stimulus: 'new_sounds/auditory_with_pink2.wav',
        choices: ['Tap'],
        data: {trial_num:trial_num,modality:'0',practice:'0',trial_tempo:'341'},
        prompt: "<p>try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        on_finish: function () {
            trial_num++;
        },
        on_start:function () {
            // alert(trial_num);
        }
    };

    var third_auditory_583 = {
        type: 'function-tap',
        stimulus: 'new_sounds/auditory_with_pink3.wav',
        choices: ['Tap'],
        data: {trial_num:trial_num,modality:'0',practice:'0',trial_tempo:'583'},
        prompt: "<p>try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        on_finish: function () {
            // trial_num++;
        }
    };

    var forth_auditory_997 = {
        type: 'function-tap',
        stimulus: 'new_sounds/auditory_with_pink4.wav',
        choices: ['Tap'],
        data: {trial_num:trial_num,modality:'0',practice:'0',trial_tempo:'997'},
        prompt: "<p>try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        on_finish: function () {
            // trial_num++;
        }
    };

    var fifth_auditory_1704 = {
        type: 'function-tap',
        stimulus: 'new_sounds/auditory_with_pink5.wav',
        choices: ['Tap'],
        data: {trial_num:trial_num,modality:'0',practice:'0',trial_tempo:'1704'},
        prompt: "<p>try tapping on the button with the same tempo</p>",
        trial_ends_after_audio: true,
        on_finish: function () {
            // trial_num++;
        }
    };

    // all_types_auditory = [first_auditory_200_pink];
    all_types_auditory = [first_auditory_200_pink,second_auditory_341,third_auditory_583,forth_auditory_997,fifth_auditory_1704];
    auditory_block = jsPsych.randomization.repeat(all_types_auditory,1);  //for now change to 1
    /////////////////////////////////////////////////////////////////////////////////////////////
    //-----------Questions----------//
    var free_text_Qs = {
        type: 'survey-text',
        questions: [
            {prompt: "What phone model did you use?"},
            {prompt: "What headphone/earphone model did you use?"},
            {prompt: "Age: "},
            {prompt: "Sex: "},
            {prompt: "Do you have any experience with musical instruments? How many years?"},
            {prompt: "Which instrument?"},
            {prompt: "Do you have any prior experience using metronomes?"},
            {prompt: "Did you receive any notifications during this last stretch?"},
            {prompt: "Were there any other problems during the experiment that you would like to report?",rows:5,columns:40}
        ],
    };

    var yes_no_options = ["Yes", "No"];
    var dominant_hand_options = ["right", "left", "other"];

    var multi_choice_block = {
        type: 'survey-multi-choice',
        questions: [
            {prompt: "Did you switch to other applications during the experiment?", options: yes_no_options},
            {prompt: "Does your phone have a screen protector?", options: yes_no_options},
            {prompt: "Dominant hand: ", options: dominant_hand_options},
            {prompt: "Have you been diagnosed with ADHD?",options: yes_no_options}
        ],
    };
    //////////////////////////////////////////////////////////////

    function push_auditory() {
        //push auditory block
        for(var i = 0; i<auditory_block.length; i++)
        {
            timeline.push(auditory_block[i]);
        }
    }

    function push_tactile() {
        //push tactile block
        for(var i = 0; i<tactile_block.length; i++)
        {
            timeline.push(tactile_block[i]);
        }
    }

    // ----------------- Create random subject ID: ----------------- //
    const subject_id = Math.floor(Math.random() * 9999999) + 1;
    jsPsych.data.addProperties({subject_id: subject_id});

    //get the time
    var date = new Date();
    month = date.getMonth()+1;
    day = date.getDate();
    hour = date.getHours();
    minutes = date.getMinutes();
    seconds = date.getSeconds();
    full_time = day.toString()+"/"+month.toString()+" ; "+hour.toString()+":"+minutes.toString()+":"+seconds.toString();
    jsPsych.data.addProperties({date:full_time});


    ///-------------------time line-------------------///
    var timeline = [];
    // timeline.push(instruction_procedure);
    timeline.push(train_begin);
    // timeline.push(loop_node3);
    // if(CONTRA_BALANCE === 0)
    // {
    //     push_auditory();
    //     push_tactile();
    // }
    // else {
    //     push_tactile();
    //     push_auditory();
    // }
    timeline.push(multi_choice_block);
    timeline.push(free_text_Qs);
    timeline.push(finished);

    ///----------------------init----------------------///

    // init for JATOS
    // jatos.onLoad(function() {
    //     jsPsych.init({
    //         timeline: timeline,
    //         preload_audio: audio,
    //         on_finish: function () {
    //                 exp_complited = 1;
    //             jsPsych.data.addProperties({First_to_run:CONTRA_BALANCE,exp_end:Date.now(),exp_completed:exp_completed});
    //             var resultJson = jsPsych.data.get().json();
    //             jatos.submitResultData(resultJson, jatos.startNextComponent);
    //             jsPsych.endExperiment('The experiment was ended by pressing N.');
    //         }
    //     });
    // });

    // init for github(w/o saving)
    jsPsych.init({
        timeline: timeline,
        preload_audio: audio,
        on_finish: function () {
            exp_completed = 1;
            jsPsych.data.addProperties({First_to_run:CONTRA_BALANCE,exp_end:Date.now(),exp_completed:exp_completed});
            saveData(subject_id, jsPsych.data.get().csv());
        }
    });

</script>
</body>
</html>